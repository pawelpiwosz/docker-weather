sudo: required
dist: trusty
language: bash

stages:
  - name: Script tests
  - name: Build test
  - name: Push container
    if: branch = master
  - name: Check container
    if: branch = master

services:
  - docker

install:
  - sudo apt-add-repository "deb http://archive.ubuntu.com/ubuntu trusty-backports main restricted universe multiverse"
  - sudo apt-get -qq update
  - sudo apt-get -t trusty-backports install shellcheck
  - sudo pip install bashate
  
jobs:
  include:
  - stage: Script tests
    script:
      - echo $TRAVIS_COMMIT
      - echo $TRAVIS_TAG
      - echo $TRAVIS_BRANCH
      - echo $TRAVIS_BUILD_NUMBER
      - echo $TRAVIS_REPO_SLUG
      # test bash scripts
      - shellcheck *.sh
      - bashate *.sh

  - stage: Build test
    script:
      - ./test.sh ${TRAVIS_BRANCH} ${TRAVIS_COMMIT}

  - stage: Push container
    #on: branch = master
    script:
      - echo "push to repo"
      - docker build -t weather .
      - docker images
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - docker tag weather ${DOCKER_USERNAME}/weather
      - docker push ${DOCKER_USERNAME}/weather
      - docker logout
      
  - stage: Check container
    script:
      - docker pull ${DOCKER_USERNAME}/weather
      #- chmod +x test-run.sh
      #- ./test-run.sh ${DOCKER_USERNAME}
      - docker run --rm ${DOCKER_USERNAME}/weather -d 3 -l "London" -b openweathermap -owm-api-key ${WEATHER_KEY}
    
